-- Basic checks
\set VERBOSITY terse
LOAD 'lolor';
SET lolor.node = 1;
CREATE EXTENSION lolor;
SELECT lo_creat(-1) AS loid \gset
SELECT lo_from_bytea(:loid, 'Example large object'); -- ERROR
ERROR:  duplicate key value violates unique constraint "pg_largeobject_metadata_pkey"
BEGIN;
SELECT lo_open(:loid, x'60000'::int) AS fd \gset
SELECT lowrite(:fd, 'Example large object');
 lowrite 
---------
      20
(1 row)

SELECT lo_close(:fd);
 lo_close 
----------
        0
(1 row)

END;
SELECT count(*) FROM pg_largeobject;
 count 
-------
     0
(1 row)

SELECT count(*) FROM lolor.pg_largeobject;
 count 
-------
     1
(1 row)

-- Check that the LO is accessible.
BEGIN;
SELECT lo_open(:loid, 262144) AS fd \gset
SELECT convert_from(loread(:fd, 1024), 'UTF8');
     convert_from     
----------------------
 Example large object
(1 row)

SELECT lo_close(:fd);
 lo_close 
----------
        0
(1 row)

END;
-- Force the oid change for the indexes
REINDEX INDEX CONCURRENTLY lolor.pg_largeobject_pkey;
REINDEX INDEX CONCURRENTLY lolor.pg_largeobject_metadata_pkey;
BEGIN;
SELECT lo_open(:loid, 262144) AS fd \gset
SELECT convert_from(loread(:fd, 1024), 'UTF8');
     convert_from     
----------------------
 Example large object
(1 row)

SELECT lo_close(:fd);
 lo_close 
----------
        0
(1 row)

END;
DROP EXTENSION lolor;
-- Check extension upgrade
CREATE EXTENSION lolor VERSION '1.0';
SELECT lo_creat(-1) AS loid \gset
ALTER EXTENSION lolor UPDATE TO '1.2.1';
BEGIN;
SELECT lo_open(:loid, x'60000'::int) AS fd \gset
SELECT lowrite(:fd, 'Example large object');
 lowrite 
---------
      20
(1 row)

END;
ALTER EXTENSION lolor UPDATE TO '1.2.2';
BEGIN;
SELECT lo_open(:loid, 262144) AS fd \gset
SELECT convert_from(loread(:fd, 1024), 'UTF8');
     convert_from     
----------------------
 Example large object
(1 row)

END;
--
-- Basic checks for enable/disable routines.
--
SELECT lolor.enable(); -- ERROR
NOTICE:  lolor still not disabled
 enable 
--------
 f
(1 row)

SELECT lo_from_bytea(1, 'Example large object stored in lolor LO storage');
 lo_from_bytea 
---------------
             1
(1 row)

SELECT lolor.disable();
 disable 
---------
 t
(1 row)

SELECT lo_open(1, 262144); -- 'not found' ERROR
ERROR:  large object 1 does not exist
SELECT lo_from_bytea(2, 'Example large object stored in built-in LO storage');
 lo_from_bytea 
---------------
             2
(1 row)

-- We should see the object
SELECT lolor.enable();
 enable 
--------
 t
(1 row)

SELECT lo_open(2, 262144); -- 'not found' ERROR
ERROR:  large object 2 does not exist
BEGIN;
SELECT lo_open(1, 262144) AS fd \gset
SELECT convert_from(loread(:fd, 1024), 'UTF8'); -- OK, see the object
                  convert_from                   
-------------------------------------------------
 Example large object stored in lolor LO storage
(1 row)

END;
-- To be sure that the behaviour is repeatable
SELECT lolor.disable();
 disable 
---------
 t
(1 row)

SELECT lolor.enable();
 enable 
--------
 t
(1 row)

DROP EXTENSION lolor;
